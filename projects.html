<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM Projects — Just Saffron</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lilex:wght@100;200;300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
<style>
/* ── CARD LAYOUT ── */
.project-card {
  display:grid; grid-template-columns:220px 1fr;
  border:1px solid var(--border); margin-bottom:1px;
  background:var(--navy-mid); position:relative; overflow:hidden;
  transition:border-color 0.3s;
  cursor:grab;
}
.project-card:active { cursor:grabbing; }
.project-card.dragging { opacity:0.38; border:2px dashed var(--saffron); }
.project-card.drag-over { border-top:3px solid var(--saffron); }
.project-card::before { content:''; position:absolute; left:0; top:0; width:3px; height:0; background:var(--saffron); transition:height 0.4s; }
.project-card:hover { border-color:rgba(232,170,68,0.3); }
.project-card:hover::before { height:100%; }

/* ── META SIDEBAR ── */
.proj-meta {
  padding:1.8rem 1.5rem; border-right:1px solid var(--border);
  display:flex; flex-direction:column; gap:0.85rem;
  background:rgba(20,24,50,0.45);
}
.proj-index {
  font-size:0.82rem; /* 4pt larger than base label */
  letter-spacing:0.3em; color:var(--sky); font-weight:400;
}
.proj-name  { font-size:1.05rem; font-weight:400; color:var(--white); line-height:1.3; }
.proj-time  { font-size:0.78rem; color:var(--text-dim); letter-spacing:0.1em; }
.proj-progress-label { font-size:0.64rem; letter-spacing:0.2em; text-transform:uppercase; color:var(--text-dim); margin-top:auto; }
.proj-progress-bar  { height:2px; background:rgba(125,183,202,0.12); margin-top:0.4rem; }
.proj-progress-fill { height:100%; background:linear-gradient(90deg,var(--blue),var(--sky)); transition:width 1.2s ease; }

/* ── ENCRYPT TOGGLE ── */
.encrypt-toggle {
  display:flex; align-items:center; gap:0.5rem;
  margin-top:0.4rem;
}
.encrypt-toggle label { font-size:0.6rem; letter-spacing:0.22em; text-transform:uppercase; color:var(--text-dim); cursor:pointer; user-select:none; }
.toggle-sw { position:relative; display:inline-block; width:32px; height:18px; cursor:pointer; }
.toggle-sw input { opacity:0; width:0; height:0; }
.toggle-track { position:absolute; inset:0; background:rgba(125,183,202,0.15); border:1px solid var(--border-sky); transition:0.3s; }
.toggle-track::before { content:''; position:absolute; width:12px; height:12px; left:2px; top:2px; background:var(--text-dim); transition:0.3s; }
.toggle-sw input:checked + .toggle-track { background:rgba(232,170,68,0.2); border-color:rgba(232,170,68,0.5); }
.toggle-sw input:checked + .toggle-track::before { transform:translateX(14px); background:var(--saffron); }

/* ── BODY AREA ── */
.proj-body { padding:1.8rem; display:flex; flex-direction:column; gap:1rem; }
.proj-fields-row { display:grid; grid-template-columns:repeat(3,1fr); gap:1.4rem; }
.proj-field label { display:block; font-size:0.64rem; letter-spacing:0.25em; text-transform:uppercase; color:var(--text-dim); margin-bottom:0.45rem; }
.proj-field p { font-size:0.84rem; font-weight:300; line-height:1.8; color:var(--text-warm); }
.proj-field.full { grid-column:1/-1; }
.proj-actions { display:flex; gap:0.8rem; padding-top:1rem; border-top:1px solid var(--border); align-items:center; flex-wrap:wrap; }
.drag-handle { font-size:1.1rem; color:var(--text-dim); cursor:grab; padding:0 0.4rem; opacity:0.5; transition:opacity 0.2s; user-select:none; }
.project-card:hover .drag-handle { opacity:1; }

/* ── ENCRYPT ANIMATION ── */
.encrypted-text {
  font-family: 'Courier New', monospace;
  font-size: 0.82rem;
  color: var(--sky);
  line-height: 1.7;
  letter-spacing: 0.05em;
  opacity: 0.85;
}
.encrypted-text .glitch-char {
  display: inline-block;
  animation: glitch-flicker 0.12s infinite steps(1);
}
@keyframes glitch-flicker {
  0%   { opacity:1; }
  25%  { opacity:0.4; }
  50%  { opacity:1; }
  75%  { opacity:0.7; }
  100% { opacity:1; }
}
.encrypt-label-badge {
  font-size:0.58rem; letter-spacing:0.25em; text-transform:uppercase;
  color:var(--sky); border:1px solid rgba(125,183,202,0.3);
  padding:0.1rem 0.5rem; margin-left:0.5rem; vertical-align:middle;
  animation: badge-pulse 2s infinite;
}
@keyframes badge-pulse { 0%,100%{opacity:1} 50%{opacity:0.45} }

/* ── SCREENSHOTS ── */
.proj-screenshots { display:flex; gap:6px; flex-wrap:wrap; padding-top:0.8rem; border-top:1px solid var(--border); }
.proj-screenshot-thumb {
  width:90px; height:60px; object-fit:cover; cursor:pointer;
  filter:saturate(0.8) brightness(0.9); transition:all 0.3s;
  border:1px solid var(--border);
}
.proj-screenshot-thumb:hover { filter:saturate(1) brightness(1); transform:scale(1.04); }
.proj-screenshot-add {
  width:90px; height:60px; border:1px dashed rgba(125,183,202,0.2);
  display:flex; align-items:center; justify-content:center;
  color:var(--text-dim); font-size:1.2rem; cursor:pointer;
  transition:all 0.3s; background:none;
}
.proj-screenshot-add:hover { border-color:var(--saffron); color:var(--saffron); }
.proj-screenshot-wrap { position:relative; }
.proj-screenshot-del {
  position:absolute; top:2px; right:2px;
  background:rgba(14,16,32,0.88); border:none; color:var(--brick-light);
  font-size:0.55rem; cursor:pointer; padding:1px 4px; font-family:var(--font); display:none;
}
.proj-screenshot-wrap:hover .proj-screenshot-del { display:block; }

/* Screenshot lightbox */
.ss-lb { position:fixed; inset:0; background:rgba(10,12,24,0.97); z-index:800; display:none; align-items:center; justify-content:center; }
.ss-lb.open { display:flex; }
.ss-lb img { max-width:90vw; max-height:88vh; object-fit:contain; }
.ss-lb-close { position:absolute; top:1.5rem; right:2rem; background:none; border:none; color:var(--text-muted); font-size:1.4rem; cursor:pointer; font-family:var(--font); }

/* ── ADD ROW ── */
.add-row { display:flex; align-items:center; justify-content:center; gap:1rem; padding:1.8rem; border:1px dashed rgba(125,183,202,0.15); color:var(--text-dim); font-size:0.78rem; letter-spacing:0.3em; text-transform:uppercase; cursor:pointer; transition:all 0.3s; margin-top:1px; background:none; font-family:var(--font); width:100%; }
.add-row:hover { border-color:rgba(232,170,68,0.38); color:var(--saffron); background:var(--saffron-dim); }
</style>
</head>
<body>
<nav>
  <a class="nav-logo" href="index.html">Just Saffron</a>
  <ul class="nav-links">
    <li><a href="projects.html" class="active">Projects</a></li>
    <li><a href="mtg.html">Decks</a></li>
    <li><a href="reviews.html">Reviews</a></li>
    <li><a href="resources.html">Resources</a></li>
    <li><a href="editor.html" class="edit-link">✦ Edit</a></li>
  </ul>
</nav>

<div class="page-header">
  <div class="page-header-left">
    <p class="page-eyebrow">01 · PM Projects</p>
    <h1 class="page-title">Product Work</h1>
    <p class="page-subtitle">A full record of PM projects — the problem, approach, time invested, and what I walked away having learned.</p>
  </div>
  <button class="btn btn-primary" onclick="requireAuth(()=>openModal('project-modal'))">+ New Project</button>
</div>

<div class="page-content">
  <div class="filter-bar">
    <button class="filter-btn active" onclick="filterProjects('all',this)">All</button>
    <button class="filter-btn" onclick="filterProjects('In Progress',this)">In Progress</button>
    <button class="filter-btn" onclick="filterProjects('Completed',this)">Completed</button>
    <button class="filter-btn" onclick="filterProjects('On Hold',this)">On Hold</button>
    <button class="filter-btn" onclick="filterProjects('Planning',this)">Planning</button>
  </div>
  <div id="project-list"></div>
  <button class="add-row" onclick="requireAuth(()=>openModal('project-modal'))">+ Add New Project</button>
</div>

<footer class="site-footer">
  <div class="site-footer-sig">Just Saffron · <a href="index.html">← Home</a></div>
  <a href="editor.html" class="btn btn-primary">✦ Edit Content</a>
</footer>

<!-- SCREENSHOT LIGHTBOX -->
<div class="ss-lb" id="ss-lb">
  <button class="ss-lb-close" onclick="document.getElementById('ss-lb').classList.remove('open')">✕</button>
  <img id="ss-lb-img" src="" alt="">
</div>

<!-- PROJECT MODAL -->
<div class="modal-bg" id="project-modal">
  <div class="modal" style="width:min(780px,95vw)">
    <div class="modal-title" id="pmod-label">New PM Project</div>
    <input type="hidden" id="p-edit-idx" value="-1">

    <div class="form-grid">
      <div class="form-row"><label>Project Name *</label><input type="text" id="p-name" placeholder="e.g. Checkout Redesign"></div>
      <div class="form-row"><label>Status</label>
        <select id="p-status"><option>In Progress</option><option>Completed</option><option>On Hold</option><option>Planning</option></select>
      </div>
      <div class="form-row"><label>Time Spent</label><input type="text" id="p-time" placeholder="e.g. 4 weeks"></div>
      <div class="form-row"><label>Progress (0–100)</label><input type="number" id="p-progress" min="0" max="100" value="0"></div>
    </div>
    <div class="form-row"><label>Problem Statement</label><textarea id="p-problem" placeholder="What problem were you solving?"></textarea></div>
    <div class="form-row"><label>Approach</label><textarea id="p-approach" placeholder="How did you go about it?"></textarea></div>
    <div class="form-row"><label>Key Learning</label><textarea id="p-learning" placeholder="What did you take away?"></textarea></div>
    <div class="form-row"><label>GitHub / Link (optional)</label><input type="url" id="p-link" placeholder="https://..."></div>

    <!-- Screenshots upload -->
    <div class="form-row">
      <label>Screenshots (multiple allowed)</label>
      <div id="modal-screenshots" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:0.6rem;"></div>
      <button type="button" class="btn btn-sky" onclick="document.getElementById('ss-upload').click()" style="font-size:0.64rem">+ Add Screenshots</button>
      <input type="file" id="ss-upload" accept="image/*" multiple style="display:none" onchange="handleSsUpload(event)">
    </div>

    <div class="modal-actions">
      <button class="btn" onclick="closeModal('project-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveProject()">Save Project</button>
    </div>
  </div>
</div>

<script src="auth.js"></script>
<script>
const KEY = 'waanderer_projects';
function getP() { return JSON.parse(localStorage.getItem(KEY)||'[]'); }
function setP(a){ localStorage.setItem(KEY,JSON.stringify(a)); }
let activeFilter = 'all';
let pendingScreenshots = []; // base64 strings being added in modal
let dragSrcIdx = null;

/* ── ENCRYPT ── */
const GLITCH_CHARS = '!@#$%^&*<>?/\\|{}[]~`01010110110011';
function encryptedHTML(text) {
  if (!text) return '';
  return '<span class="encrypted-text">' +
    text.split('').map(c => {
      if (c === ' ') return ' ';
      if (c === '\n') return '<br>';
      // pick a random replacement char
      const r = GLITCH_CHARS[Math.floor(Math.random()*GLITCH_CHARS.length)];
      const delay = (Math.random()*0.8).toFixed(2);
      const dur   = (0.08 + Math.random()*0.2).toFixed(2);
      return `<span class="glitch-char" style="animation-delay:${delay}s;animation-duration:${dur}s">${r}</span>`;
    }).join('') +
  '</span>';
}

/* live re-scramble every 150ms for encrypted cards */
let encryptTimers = {};
function startEncryptTimer(cardEl, p) {
  const id = p.name;
  if (encryptTimers[id]) return;
  encryptTimers[id] = setInterval(() => {
    cardEl.querySelectorAll('.glitch-char').forEach(span => {
      const r = GLITCH_CHARS[Math.floor(Math.random()*GLITCH_CHARS.length)];
      span.textContent = r;
    });
  }, 120);
}

/* ── STATUS DOT ── */
function statusDot(s) {
  if (s==='In Progress') return '<span class="dot dot-active"></span>';
  if (s==='Completed')   return '<span class="dot dot-done"></span>';
  return '<span class="dot dot-hold"></span>';
}

/* ── TOGGLE ENCRYPT ── */
function toggleEncrypt(idx) {
  if (!checkEditAuth()) { requireAuth(() => toggleEncrypt(idx)); return; }
  const arr = getP();
  arr[idx].encrypted = !arr[idx].encrypted;
  setP(arr);
  render();
}

/* ── SCREENSHOTS ── */
function handleSsUpload(e) {
  Array.from(e.target.files).forEach(f => {
    const r = new FileReader();
    r.onload = ev => {
      pendingScreenshots.push(ev.target.result);
      renderModalScreenshots();
    };
    r.readAsDataURL(f);
  });
  e.target.value = '';
}

function renderModalScreenshots() {
  const wrap = document.getElementById('modal-screenshots');
  wrap.innerHTML = pendingScreenshots.map((src,i) => `
    <div style="position:relative">
      <img src="${src}" style="width:90px;height:60px;object-fit:cover;border:1px solid var(--border)">
      <button onclick="removePendingSs(${i})" style="position:absolute;top:2px;right:2px;background:rgba(14,16,32,0.88);border:none;color:var(--brick-light);font-size:0.55rem;cursor:pointer;padding:1px 4px;font-family:var(--font)">✕</button>
    </div>`).join('');
}

function removePendingSs(i) { pendingScreenshots.splice(i,1); renderModalScreenshots(); }

function deleteScreenshot(projIdx, ssIdx) {
  if (!confirm('Remove screenshot?')) return;
  const arr = getP();
  arr[projIdx].screenshots.splice(ssIdx,1);
  setP(arr); render();
}

/* ── SAVE PROJECT ── */
function saveProject() {
  const idx = parseInt(document.getElementById('p-edit-idx').value);
  const existing = idx >= 0 ? (getP()[idx].screenshots || []) : [];
  const p = {
    name:      document.getElementById('p-name').value.trim(),
    status:    document.getElementById('p-status').value,
    time:      document.getElementById('p-time').value.trim(),
    progress:  parseInt(document.getElementById('p-progress').value)||0,
    problem:   document.getElementById('p-problem').value.trim(),
    approach:  document.getElementById('p-approach').value.trim(),
    learning:  document.getElementById('p-learning').value.trim(),
    link:      document.getElementById('p-link').value.trim(),
    screenshots: [...existing, ...pendingScreenshots],
    encrypted: idx >= 0 ? (getP()[idx].encrypted || false) : false,
    date:      idx >= 0 ? (getP()[idx].date || '') : new Date().toLocaleDateString('en-GB',{month:'short',year:'numeric'})
  };
  if (!p.name) return alert('Please add a project name.');
  const arr = getP();
  if (idx >= 0) arr[idx] = p; else arr.push(p);
  setP(arr);
  closeModal('project-modal');
  render();
}

function deleteProject(idx) {
  if (!confirm('Delete this project?')) return;
  const a = getP(); a.splice(idx,1); setP(a); render();
}

function editProject(idx) {
  const p = getP()[idx];
  pendingScreenshots = [];
  document.getElementById('p-edit-idx').value = idx;
  document.getElementById('pmod-label').textContent = 'Edit Project';
  document.getElementById('p-name').value = p.name;
  document.getElementById('p-status').value = p.status;
  document.getElementById('p-time').value = p.time || '';
  document.getElementById('p-progress').value = p.progress || 0;
  document.getElementById('p-problem').value = p.problem || '';
  document.getElementById('p-approach').value = p.approach || '';
  document.getElementById('p-learning').value = p.learning || '';
  document.getElementById('p-link').value = p.link || '';
  renderModalScreenshots();
  requireAuth(() => openModal('project-modal'));
}

function filterProjects(f, btn) {
  activeFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  render();
}

/* ── DRAG & DROP REORDER ── */
function initDragDrop() {
  const list = document.getElementById('project-list');
  let dragging = null;

  list.querySelectorAll('.project-card').forEach((card, i) => {
    card.setAttribute('draggable', 'true');
    card.dataset.idx = i;

    card.addEventListener('dragstart', e => {
      dragging = card;
      dragSrcIdx = parseInt(card.dataset.idx);
      setTimeout(() => card.classList.add('dragging'), 0);
      e.dataTransfer.effectAllowed = 'move';
    });
    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      list.querySelectorAll('.project-card').forEach(c => c.classList.remove('drag-over'));
      dragging = null;
    });
    card.addEventListener('dragover', e => {
      e.preventDefault();
      if (card !== dragging) {
        list.querySelectorAll('.project-card').forEach(c => c.classList.remove('drag-over'));
        card.classList.add('drag-over');
      }
    });
    card.addEventListener('drop', e => {
      e.preventDefault();
      const targetIdx = parseInt(card.dataset.idx);
      if (dragSrcIdx === null || dragSrcIdx === targetIdx) return;
      const arr = getP();
      const [moved] = arr.splice(dragSrcIdx,1);
      arr.splice(targetIdx,0,moved);
      setP(arr);
      render();
    });
  });
}

/* ── RENDER ── */
function render() {
  // stop old encrypt timers
  Object.values(encryptTimers).forEach(t => clearInterval(t));
  encryptTimers = {};

  const all = getP();
  const filtered = activeFilter === 'all' ? all : all.filter(p => p.status === activeFilter);
  const list = document.getElementById('project-list');

  if (!filtered.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">⬡</div><p>${activeFilter==='all'?'No projects yet — add your first one':'No projects with this status'}</p></div>`;
    return;
  }

  list.innerHTML = filtered.map(p => {
    const ri = all.indexOf(p);
    const enc = !!p.encrypted;
    const lnk = p.link ? `<a href="${p.link}" target="_blank" class="btn" style="font-size:0.64rem">↗ View</a>` : '';
    const screenshots = (p.screenshots || []);

    const fieldContent = (label, val) => {
      if (!val) return '';
      const inner = enc ? encryptedHTML(val) : `<p>${val}</p>`;
      return `<div class="proj-field"><label>${label}</label>${inner}</div>`;
    };

    const ssHTML = screenshots.length || checkEditAuth() ? `
      <div class="proj-screenshots">
        ${screenshots.map((src, si) => `
          <div class="proj-screenshot-wrap">
            <img src="${src}" class="proj-screenshot-thumb" onclick="openSsLb('${src}')" alt="Screenshot">
            <button class="proj-screenshot-del" onclick="requireAuth(()=>deleteScreenshot(${ri},${si}))">✕</button>
          </div>`).join('')}
        <button class="proj-screenshot-add" title="Add screenshots" onclick="requireAuth(()=>quickAddSs(${ri}))">+</button>
      </div>` : '';

    return `<div class="project-card reveal" data-idx="${ri}">
      <div class="proj-meta">
        <div class="proj-index">PRJ-${String(ri+1).padStart(3,'0')}</div>
        <div class="proj-name">${enc ? '<span class="encrypt-label-badge">ENCRYPTED</span>' : p.name}</div>
        ${p.time ? `<div class="proj-time">⏱ ${p.time}</div>` : ''}
        <div class="status-pill">${statusDot(p.status)}<span style="color:var(--text-muted)">${p.status}</span></div>
        <div style="margin-top:auto">
          <div class="proj-progress-label">${p.progress}% complete</div>
          <div class="proj-progress-bar"><div class="proj-progress-fill" style="width:0%" data-w="${p.progress}%"></div></div>
        </div>
        ${checkEditAuth() ? `<div class="encrypt-toggle">
          <label class="toggle-sw" title="Encrypt project text">
            <input type="checkbox" ${enc?'checked':''} onchange="toggleEncrypt(${ri})">
            <div class="toggle-track"></div>
          </label>
          <label onclick="toggleEncrypt(${ri})">Encrypt</label>
        </div>` : ''}
      </div>
      <div class="proj-body">
        <div class="proj-fields-row">
          ${fieldContent('Problem',p.problem)}
          ${fieldContent('Approach',p.approach)}
          ${fieldContent('Key Learning',p.learning)}
        </div>
        ${ssHTML}
        <div class="proj-actions">
          <span class="drag-handle" title="Drag to reorder">⠿</span>
          <button class="btn" onclick="requireAuth(()=>editProject(${ri}))">✎ Edit</button>
          <button class="btn btn-danger" onclick="requireAuth(()=>deleteProject(${ri}))">✕ Delete</button>
          ${lnk}
          ${p.date ? `<span style="margin-left:auto;font-size:0.62rem;color:var(--text-dim);align-self:center">Added ${p.date}</span>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');

  // animate progress bars + reveal
  setTimeout(() => {
    document.querySelectorAll('.proj-progress-fill').forEach(el => el.style.width = el.dataset.w);
    document.querySelectorAll('.reveal').forEach(el => el.classList.add('visible'));
    // start encrypt timers
    document.querySelectorAll('.project-card').forEach((card, i) => {
      const p = filtered[i];
      if (p && p.encrypted) startEncryptTimer(card, p);
    });
  }, 50);

  initDragDrop();
}

/* ── QUICK ADD SCREENSHOTS (from card) ── */
function quickAddSs(projIdx) {
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = 'image/*'; inp.multiple = true;
  inp.onchange = e => {
    const arr = getP();
    let done = 0;
    const files = Array.from(e.target.files);
    files.forEach(f => {
      const r = new FileReader();
      r.onload = ev => {
        arr[projIdx].screenshots = arr[projIdx].screenshots || [];
        arr[projIdx].screenshots.push(ev.target.result);
        done++;
        if (done === files.length) { setP(arr); render(); }
      };
      r.readAsDataURL(f);
    });
  };
  inp.click();
}

function openSsLb(src) {
  document.getElementById('ss-lb-img').src = src;
  document.getElementById('ss-lb').classList.add('open');
}

/* ── MODAL HELPERS ── */
function openModal(id) {
  if (id === 'project-modal' && document.getElementById('p-edit-idx').value === '-1') {
    document.getElementById('pmod-label').textContent = 'New PM Project';
    ['p-name','p-time','p-problem','p-approach','p-learning','p-link'].forEach(f => document.getElementById(f).value = '');
    document.getElementById('p-progress').value = 0;
    document.getElementById('p-status').value = 'In Progress';
    pendingScreenshots = [];
    renderModalScreenshots();
  }
  document.getElementById(id).classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  document.getElementById('p-edit-idx').value = '-1';
  document.body.style.overflow = '';
}
document.querySelectorAll('.modal-bg').forEach(bg => bg.addEventListener('click', e => { if(e.target===bg) closeModal(bg.id); }));
document.addEventListener('keydown', e => {
  if (e.key==='Escape') {
    document.querySelectorAll('.modal-bg.open').forEach(m => closeModal(m.id));
    document.getElementById('ss-lb').classList.remove('open');
  }
});

render();
</script>
</body>
</html>
