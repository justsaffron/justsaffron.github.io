<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Photography ‚Äî Just Saffron</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lilex:wght@100;200;300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
<style>
/* ‚îÄ‚îÄ MASONRY ‚Üí but also allow drag reorder so use grid ‚îÄ‚îÄ */
.photo-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:2px;
}

.photo-item {
  aspect-ratio:1/1; position:relative; overflow:hidden;
  cursor:grab; background:var(--navy-mid);
  border:2px solid transparent; transition:border-color 0.2s;
}
.photo-item:active { cursor:grabbing; }
.photo-item.dragging-ph  { opacity:0.35; border:2px dashed var(--saffron); }
.photo-item.drag-over-ph { border:2px solid var(--saffron); }

.photo-item img {
  width:100%; height:100%; object-fit:cover; display:block;
  filter:saturate(0.82) brightness(0.9); transition:filter 0.4s,transform 0.5s;
  pointer-events:none;
}
.photo-item:hover img { filter:saturate(1.05) brightness(1); transform:scale(1.04); }

.photo-cap {
  position:absolute; bottom:0; left:0; right:0;
  padding:1.5rem 0.8rem 0.7rem;
  background:linear-gradient(0deg,rgba(20,24,50,0.92),transparent);
  opacity:0; transition:opacity 0.3s;
}
.photo-item:hover .photo-cap { opacity:1; }
.photo-cap-title { font-size:0.82rem; color:var(--white); }
.photo-cap-loc   { font-size:0.64rem; color:var(--text-muted); margin-top:0.2rem; }
.photo-cap-del {
  position:absolute; top:0.5rem; right:0.5rem;
  background:rgba(20,24,50,0.88); border:none; color:var(--brick-light);
  font-size:0.6rem; cursor:pointer; padding:0.2rem 0.45rem; font-family:var(--font);
}

.add-zone {
  border:1px dashed rgba(125,183,202,0.15); padding:4rem 2rem;
  text-align:center; color:var(--text-dim); cursor:pointer;
  transition:all 0.3s; margin-top:2px; background:none;
  width:100%; font-family:var(--font);
}
.add-zone:hover { border-color:rgba(232,170,68,0.38); color:var(--saffron); }

/* ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ */
.ph-lb { position:fixed; inset:0; background:rgba(10,12,24,0.97); z-index:600; display:none; align-items:center; justify-content:center; flex-direction:column; }
.ph-lb.open { display:flex; }
.ph-lb img  { max-width:88vw; max-height:78vh; object-fit:contain; }
.ph-lb-close { position:absolute; top:1.5rem; right:2rem; background:none; border:none; color:var(--text-muted); font-size:1.4rem; cursor:pointer; font-family:var(--font); }
.ph-lb-nav { position:absolute; top:50%; transform:translateY(-50%); background:rgba(20,24,50,0.8); border:1px solid var(--border); color:var(--text-warm); font-size:1.2rem; cursor:pointer; padding:0.8rem; font-family:var(--font); transition:all 0.2s; }
.ph-lb-nav:hover { color:var(--white); }
.ph-lb-nav.prev { left:1.5rem; }
.ph-lb-nav.next { right:1.5rem; }

.toolbar-row {
  display:flex; align-items:center; gap:1rem; margin-bottom:1.2rem;
  font-size:0.64rem; color:var(--text-dim); letter-spacing:0.15em; flex-wrap:wrap;
}
</style>
</head>
<body>
<nav>
  <a class="nav-logo" href="index.html">Just Saffron</a>
  <ul class="nav-links">
    <li><a href="projects.html">Projects</a></li>
    <li><a href="mtg.html">Decks</a></li>
    <li><a href="moodboards.html">Moodboards</a></li>
    <li><a href="photography.html" class="active">Photography</a></li>
    <li><a href="reviews.html">Reviews</a></li>
    <li><a href="resources.html">Resources</a></li>
    <li><a href="editor.html" class="edit-link">‚ú¶ Edit</a></li>
  </ul>
</nav>

<div class="page-header">
  <div class="page-header-left">
    <p class="page-eyebrow">04 ¬∑ Photography</p>
    <h1 class="page-title">Moments Caught</h1>
    <p class="page-subtitle">Personal photography from travels and everyday observation. Each image is a moment from the wander.</p>
  </div>
  <button class="btn btn-primary" onclick="requireAuth(()=>document.getElementById('ph-upload').click())">+ Upload Photos</button>
</div>

<div class="page-content">
  <div class="filter-bar" id="tag-bar">
    <button class="filter-btn active" onclick="filterTag('all',this)">All</button>
  </div>
  <div class="toolbar-row">
    <span>Drag photos to reorder ¬∑ Hover to delete</span>
    <button class="btn btn-sky" style="font-size:0.64rem;margin-left:auto" onclick="requireAuth(()=>document.getElementById('ph-upload').click())">+ Add More Photos</button>
  </div>
  <div class="photo-grid" id="ph-grid"></div>
  <button class="add-zone" onclick="requireAuth(()=>document.getElementById('ph-upload').click())">
    <div style="font-size:1.8rem;font-weight:100;margin-bottom:0.5rem">+</div>
    <div style="font-size:0.78rem;letter-spacing:0.3em;text-transform:uppercase">Upload Photos</div>
  </button>
</div>

<footer class="site-footer"><div class="site-footer-sig">Just Saffron ¬∑ <a href="index.html">‚Üê Home</a></div></footer>

<!-- FULLSCREEN LIGHTBOX -->
<div class="ph-lb" id="ph-lb">
  <button class="ph-lb-close" onclick="closeLB()">‚úï</button>
  <button class="ph-lb-nav prev" onclick="lbNav(-1)">‚Äπ</button>
  <button class="ph-lb-nav next" onclick="lbNav(1)">‚Ä∫</button>
  <img id="lb-img" src="" alt="">
  <div style="margin-top:0.8rem;text-align:center">
    <div id="lb-t" style="font-size:0.9rem;color:var(--white)"></div>
    <div id="lb-l" style="font-size:0.7rem;color:var(--text-muted);margin-top:0.3rem"></div>
  </div>
</div>

<!-- META MODAL -->
<div class="modal-bg" id="ph-meta-modal">
  <div class="modal">
    <div class="modal-title">Photo Details</div>
    <div id="ph-prev-wrap" style="margin-bottom:1.5rem;text-align:center"></div>
    <div class="form-row"><label>Title (optional)</label><input type="text" id="ph-title" placeholder="e.g. Medina at Dusk"></div>
    <div class="form-row"><label>Location</label><input type="text" id="ph-loc" placeholder="e.g. Marrakech, Morocco"></div>
    <div class="form-row"><label>Date</label><input type="date" id="ph-date"></div>
    <div class="form-row"><label>Tags (comma-separated)</label><input type="text" id="ph-tags" placeholder="e.g. travel, architecture, golden hour"></div>
    <div class="modal-actions">
      <button class="btn" onclick="skipMeta()">Skip</button>
      <button class="btn btn-primary" onclick="saveMeta()">Save</button>
    </div>
  </div>
</div>

<input type="file" id="ph-upload" accept="image/*" multiple style="display:none" onchange="handleUpload(event)">

<script src="auth.js"></script>
<script>
const KEY = 'waanderer_photos';
let pending = [], pendIdx = 0, lbIdx = 0, activeTag = 'all';
let phDragSrc = null;

function getP() { return JSON.parse(localStorage.getItem(KEY)||'[]'); }
function setP(a){ localStorage.setItem(KEY,JSON.stringify(a)); }

function cropSq(src, cb) {
  const img = new Image();
  img.onload = () => {
    const s = Math.min(img.width,img.height);
    const c = document.createElement('canvas'); c.width=600; c.height=600;
    c.getContext('2d').drawImage(img,(img.width-s)/2,(img.height-s)/2,s,s,0,0,600,600);
    cb(c.toDataURL('image/jpeg',0.85));
  };
  img.src = src;
}

function handleUpload(e) {
  const files = Array.from(e.target.files);
  pending = []; pendIdx = 0; let done = 0;
  files.forEach(f => {
    const r = new FileReader();
    r.onload = ev => {
      cropSq(ev.target.result, sq => {
        pending.push({ src:sq, title:'', loc:'', date:'', tags:[] });
        done++;
        if (done === files.length) showNextMeta();
      });
    };
    r.readAsDataURL(f);
  });
  e.target.value = '';
}

function showNextMeta() {
  if (pendIdx >= pending.length) {
    const a = getP(); pending.forEach(p => a.unshift(p)); setP(a); render(); return;
  }
  const p = pending[pendIdx];
  document.getElementById('ph-title').value = '';
  document.getElementById('ph-loc').value   = '';
  document.getElementById('ph-date').value  = '';
  document.getElementById('ph-tags').value  = '';
  document.getElementById('ph-prev-wrap').innerHTML =
    `<img src="${p.src}" style="max-height:150px;max-width:100%;object-fit:contain">
     <div style="font-size:0.62rem;color:var(--text-dim);margin-top:0.4rem;letter-spacing:0.2em">Photo ${pendIdx+1} of ${pending.length}</div>`;
  document.getElementById('ph-meta-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function saveMeta() {
  const tags = document.getElementById('ph-tags').value.split(',').map(t=>t.trim()).filter(Boolean);
  pending[pendIdx].title = document.getElementById('ph-title').value.trim();
  pending[pendIdx].loc   = document.getElementById('ph-loc').value.trim();
  pending[pendIdx].date  = document.getElementById('ph-date').value;
  pending[pendIdx].tags  = tags;
  document.getElementById('ph-meta-modal').classList.remove('open');
  document.body.style.overflow = '';
  pendIdx++; showNextMeta();
}
function skipMeta() {
  document.getElementById('ph-meta-modal').classList.remove('open');
  document.body.style.overflow = '';
  pendIdx++; showNextMeta();
}

function deletePhoto(idx) {
  if (!confirm('Delete this photo?')) return;
  const a = getP(); a.splice(idx,1); setP(a); render();
}

/* ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ */
function openLB(idx) {
  lbIdx = idx; updateLB();
  document.getElementById('ph-lb').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function updateLB() {
  const all = getP();
  const filtered = activeTag==='all'?all:all.filter(p=>(p.tags||[]).includes(activeTag));
  const p = filtered[lbIdx];
  if (!p) return;
  document.getElementById('lb-img').src = p.src;
  document.getElementById('lb-t').textContent = p.title||'';
  document.getElementById('lb-l').textContent = [p.loc,p.date].filter(Boolean).join(' ¬∑ ');
}
function lbNav(d) {
  const all = getP();
  const filtered = activeTag==='all'?all:all.filter(p=>(p.tags||[]).includes(activeTag));
  lbIdx = (lbIdx+d+filtered.length)%filtered.length; updateLB();
}
function closeLB() { document.getElementById('ph-lb').classList.remove('open'); document.body.style.overflow=''; }

/* ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ */
function filterTag(t, btn) {
  activeTag = t;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); render();
}
function buildTagBar(photos) {
  const tags = new Set();
  photos.forEach(p=>(p.tags||[]).forEach(t=>tags.add(t)));
  const bar = document.getElementById('tag-bar');
  bar.querySelectorAll('.filter-btn:not(:first-child)').forEach(b=>b.remove());
  tags.forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'filter-btn' + (t===activeTag?' active':'');
    btn.textContent = t;
    btn.onclick = () => filterTag(t,btn);
    bar.appendChild(btn);
  });
}

/* ‚îÄ‚îÄ DRAG REORDER ‚îÄ‚îÄ */
function initPhotoDrag() {
  const grid = document.getElementById('ph-grid');
  grid.querySelectorAll('.photo-item').forEach(item => {
    item.addEventListener('dragstart', e => {
      phDragSrc = parseInt(item.dataset.realIdx);
      setTimeout(()=>item.classList.add('dragging-ph'),0);
      e.dataTransfer.effectAllowed='move';
    });
    item.addEventListener('dragend', ()=>{
      item.classList.remove('dragging-ph');
      grid.querySelectorAll('.photo-item').forEach(c=>c.classList.remove('drag-over-ph'));
    });
    item.addEventListener('dragover', e=>{
      e.preventDefault();
      if(parseInt(item.dataset.realIdx)!==phDragSrc){
        grid.querySelectorAll('.photo-item').forEach(c=>c.classList.remove('drag-over-ph'));
        item.classList.add('drag-over-ph');
      }
    });
    item.addEventListener('drop', e=>{
      e.preventDefault();
      const ti = parseInt(item.dataset.realIdx);
      if(phDragSrc===null||phDragSrc===ti) return;
      // reorder in full array
      const all = getP();
      const [m] = all.splice(phDragSrc,1); all.splice(ti,0,m);
      setP(all); render();
    });
  });
}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
function render() {
  const all = getP(); buildTagBar(all);
  const filtered = activeTag==='all'?all:all.filter(p=>(p.tags||[]).includes(activeTag));
  const grid = document.getElementById('ph-grid');
  if (!filtered.length) {
    grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:4rem;color:var(--text-dim);font-size:0.78rem;letter-spacing:0.2em;text-transform:uppercase">No photos yet</div>`;
    return;
  }
  grid.innerHTML = filtered.map((p, fi) => {
    const ri = all.indexOf(p);
    return `<div class="photo-item" draggable="true" data-real-idx="${ri}" data-filtered-idx="${fi}">
      <img src="${p.src}" alt="${p.title||''}" onclick="openLB(${fi})">
      <div class="photo-cap">
        ${p.title?`<div class="photo-cap-title">${p.title}</div>`:''}
        ${p.loc?`<div class="photo-cap-loc">üìç ${p.loc}</div>`:''}
        <button class="photo-cap-del" onclick="event.stopPropagation();requireAuth(()=>deletePhoto(${ri}))">‚úï</button>
      </div>
    </div>`;
  }).join('');

  initPhotoDrag();
}

document.addEventListener('keydown',e=>{
  if(e.key==='Escape') closeLB();
  if(e.key==='ArrowLeft') lbNav(-1);
  if(e.key==='ArrowRight') lbNav(1);
});
document.querySelectorAll('.modal-bg').forEach(bg=>bg.addEventListener('click',e=>{if(e.target===bg){document.getElementById('ph-meta-modal').classList.remove('open');document.body.style.overflow=''}}));

render();
</script>
</body>
</html>
