<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Moodboards — Just Saffron</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lilex:wght@100;200;300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
<style>
/* ── BOARD GRID ── */
.boards-grid {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:1px; background:var(--border-sky);
}

.board-card {
  background:var(--navy-mid); position:relative; overflow:hidden;
  cursor:pointer; aspect-ratio:1/1; display:flex; flex-direction:column;
  transition:background 0.3s;
}
.board-mosaic {
  flex:1; display:grid; grid-template-columns:1fr 1fr;
  grid-template-rows:1fr 1fr; overflow:hidden;
}
.board-thumb { overflow:hidden; background:var(--navy-deep); }
.board-thumb img {
  width:100%; height:100%; object-fit:cover; display:block;
  filter:saturate(0.82); transition:transform 0.5s,filter 0.3s;
}
.board-card:hover .board-thumb img { transform:scale(1.06); filter:saturate(1.08); }
.board-thumb-empty {
  display:flex; align-items:center; justify-content:center;
  color:var(--text-dim); font-size:1rem; background:rgba(48,55,99,0.4);
}
.board-info { padding:1rem 1.2rem; background:rgba(20,24,50,0.95); }
.board-name  { font-size:0.88rem; font-weight:400; color:var(--white); margin-bottom:0.2rem; }
.board-desc  { font-size:0.78rem; color:var(--text-muted); line-height:1.5; }
.board-count { font-size:0.64rem; letter-spacing:0.2em; text-transform:uppercase; color:var(--text-dim); margin-top:0.35rem; }
.board-hover {
  position:absolute; inset:0; background:rgba(20,24,50,0.75);
  display:flex; align-items:center; justify-content:center;
  flex-direction:column; gap:0.5rem; opacity:0; transition:opacity 0.3s;
}
.board-card:hover .board-hover { opacity:1; }
.board-hover span { font-size:0.68rem; letter-spacing:0.3em; text-transform:uppercase; color:var(--saffron); }

.add-board-btn {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:0.8rem; aspect-ratio:1/1; border:1px dashed rgba(125,183,202,0.15);
  background:transparent; color:var(--text-dim); font-size:0.68rem;
  letter-spacing:0.2em; text-transform:uppercase; cursor:pointer;
  transition:all 0.3s; font-family:var(--font);
}
.add-board-btn:hover { border-color:rgba(232,170,68,0.4); color:var(--saffron); background:var(--saffron-dim); }

/* ── LIGHTBOX ── */
.lb { position:fixed; inset:0; background:rgba(10,12,24,0.98); z-index:600; display:none; flex-direction:column; }
.lb.open { display:flex; }
.lb-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:1.2rem 2rem; border-bottom:1px solid var(--border); flex-shrink:0;
}
.lb-title { font-size:0.9rem; font-weight:300; color:var(--white); }
.lb-desc  { font-size:0.72rem; color:var(--text-muted); margin-top:0.2rem; }
.lb-close {
  background:none; border:none; color:var(--text-muted); font-size:1.2rem;
  cursor:pointer; font-family:var(--font); transition:color 0.2s;
}
.lb-close:hover { color:var(--white); }

.lb-body  { flex:1; overflow-y:auto; padding:1.5rem; }
.lb-grid  { display:grid; grid-template-columns:repeat(auto-fill,minmax(175px,1fr)); gap:2px; }

/* draggable image items */
.lb-img-item {
  aspect-ratio:1/1; overflow:hidden; position:relative;
  cursor:grab; background:var(--navy-mid);
  border:2px solid transparent; transition:border-color 0.2s;
}
.lb-img-item:active { cursor:grabbing; }
.lb-img-item.dragging-img { opacity:0.35; border:2px dashed var(--saffron); }
.lb-img-item.drag-over-img { border:2px solid var(--saffron); }
.lb-img-item img {
  width:100%; height:100%; object-fit:cover; display:block;
  filter:saturate(0.88); transition:transform 0.4s,filter 0.3s; pointer-events:none;
}
.lb-img-item:hover img { transform:scale(1.05); filter:saturate(1.05); }
.lb-del {
  position:absolute; top:4px; right:4px; background:rgba(14,16,32,0.88);
  border:none; color:var(--brick-light); font-size:0.64rem;
  cursor:pointer; padding:0.2rem 0.45rem; font-family:var(--font); display:none;
}
.lb-img-item:hover .lb-del { display:block; }

.lb-add {
  aspect-ratio:1/1; border:1px dashed rgba(125,183,202,0.2);
  display:flex; align-items:center; justify-content:center;
  color:var(--text-dim); font-size:0.68rem; letter-spacing:0.2em;
  text-transform:uppercase; cursor:pointer; flex-direction:column;
  gap:0.5rem; transition:all 0.3s; background:none; font-family:var(--font);
}
.lb-add:hover { border-color:rgba(232,170,68,0.4); color:var(--saffron); }

.lb-toolbar {
  display:flex; gap:0.8rem; padding:0.8rem 2rem;
  border-bottom:1px solid var(--border); background:rgba(20,24,50,0.5);
  align-items:center; font-size:0.64rem; color:var(--text-dim);
  letter-spacing:0.15em; flex-shrink:0;
}
</style>
</head>
<body>
<nav>
  <a class="nav-logo" href="index.html">Just Saffron</a>
  <ul class="nav-links">
    <li><a href="projects.html">Projects</a></li>
    <li><a href="mtg.html">Decks</a></li>
    <li><a href="moodboards.html" class="active">Moodboards</a></li>
    <li><a href="photography.html">Photography</a></li>
    <li><a href="reviews.html">Reviews</a></li>
    <li><a href="resources.html">Resources</a></li>
    <li><a href="editor.html" class="edit-link">✦ Edit</a></li>
  </ul>
</nav>

<div class="page-header">
  <div class="page-header-left">
    <p class="page-eyebrow">03 · Moodboards</p>
    <h1 class="page-title">Visual Worlds</h1>
    <p class="page-subtitle">Collections of art, illustration, and visual references that shape how I see the world.</p>
  </div>
  <button class="btn btn-primary" onclick="requireAuth(()=>openModal('board-modal'))">+ New Board</button>
</div>

<div class="page-content">
  <div class="boards-grid" id="boards-grid"></div>
</div>

<footer class="site-footer">
  <div class="site-footer-sig">Just Saffron · <a href="index.html">← Home</a></div>
</footer>

<!-- LIGHTBOX -->
<div class="lb" id="lb">
  <div class="lb-header">
    <div>
      <div class="lb-title" id="lb-title">Board</div>
      <div class="lb-desc" id="lb-desc"></div>
    </div>
    <div style="display:flex;gap:0.8rem;align-items:center">
      <button class="btn btn-danger" id="lb-del-board" style="font-size:0.62rem">✕ Delete Board</button>
      <button class="lb-close" onclick="closeLB()">✕ Close</button>
    </div>
  </div>
  <div class="lb-toolbar">
    <span>Drag images to reorder · Hover to delete</span>
    <button class="btn btn-primary" id="lb-add-btn" style="font-size:0.62rem;margin-left:auto">+ Add Images</button>
  </div>
  <div class="lb-body"><div class="lb-grid" id="lb-grid"></div></div>
</div>

<!-- NEW BOARD MODAL -->
<div class="modal-bg" id="board-modal">
  <div class="modal">
    <div class="modal-title">New Moodboard</div>
    <div class="form-row"><label>Board Title *</label><input type="text" id="b-name" placeholder="e.g. Desert Cityscapes"></div>
    <div class="form-row"><label>Description</label><textarea id="b-desc" placeholder="What's the vibe or theme?"></textarea></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('board-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="createBoard()">Create Board</button>
    </div>
  </div>
</div>

<!-- hidden file input — always available -->
<input type="file" id="img-upload" accept="image/*" multiple style="display:none" onchange="handleImgUpload(event)">

<script src="auth.js"></script>
<script>
const KEY = 'waanderer_boards';
let activeBoardIdx = -1;
let imgDragSrc = null;

function getB() { return JSON.parse(localStorage.getItem(KEY)||'[]'); }
function setB(a){ localStorage.setItem(KEY,JSON.stringify(a)); }

/* ── CROP TO SQUARE ── */
function cropToSquare(src, cb) {
  const img = new Image();
  img.onload = () => {
    const size = Math.min(img.width,img.height);
    const canvas = document.createElement('canvas'); canvas.width=400; canvas.height=400;
    canvas.getContext('2d').drawImage(img,(img.width-size)/2,(img.height-size)/2,size,size,0,0,400,400);
    cb(canvas.toDataURL('image/jpeg',0.82));
  };
  img.src = src;
}

function createBoard() {
  const name = document.getElementById('b-name').value.trim();
  if (!name) return alert('Please enter a board title.');
  const arr = getB();
  arr.push({ name, desc: document.getElementById('b-desc').value.trim(), images:[] });
  setB(arr); closeModal('board-modal');
  document.getElementById('b-name').value = '';
  document.getElementById('b-desc').value = '';
  render();
}

function deleteBoard(idx) {
  if (!confirm('Delete entire board and all images?')) return;
  const a = getB(); a.splice(idx,1); setB(a); closeLB(); render();
}

/* ── LIGHTBOX ── */
function openLB(idx) {
  activeBoardIdx = idx;
  const b = getB()[idx];
  document.getElementById('lb-title').textContent = b.name;
  document.getElementById('lb-desc').textContent  = b.desc||'';
  document.getElementById('lb-del-board').onclick  = () => requireAuth(() => deleteBoard(idx));
  document.getElementById('lb-add-btn').onclick    = () => requireAuth(() => document.getElementById('img-upload').click());
  renderLBImages(b.images||[]);
  document.getElementById('lb').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeLB() {
  document.getElementById('lb').classList.remove('open');
  document.body.style.overflow = '';
  activeBoardIdx = -1;
}

function renderLBImages(images) {
  const grid = document.getElementById('lb-grid');

  grid.innerHTML = images.map((src, i) => `
    <div class="lb-img-item" draggable="true" data-img-idx="${i}">
      <img src="${src}" alt="">
      <button class="lb-del" onclick="requireAuth(()=>removeImg(${i}))">✕</button>
    </div>`).join('') +
    `<button class="lb-add" onclick="requireAuth(()=>document.getElementById('img-upload').click())">
      <span style="font-size:1.4rem;font-weight:100">+</span><span>Add Images</span>
    </button>`;

  // drag to reorder
  grid.querySelectorAll('.lb-img-item').forEach(item => {
    item.addEventListener('dragstart', e => {
      imgDragSrc = parseInt(item.dataset.imgIdx);
      setTimeout(()=>item.classList.add('dragging-img'),0);
      e.dataTransfer.effectAllowed = 'move';
    });
    item.addEventListener('dragend', () => {
      item.classList.remove('dragging-img');
      grid.querySelectorAll('.lb-img-item').forEach(c=>c.classList.remove('drag-over-img'));
    });
    item.addEventListener('dragover', e => {
      e.preventDefault();
      if (parseInt(item.dataset.imgIdx) !== imgDragSrc) {
        grid.querySelectorAll('.lb-img-item').forEach(c=>c.classList.remove('drag-over-img'));
        item.classList.add('drag-over-img');
      }
    });
    item.addEventListener('drop', e => {
      e.preventDefault();
      const ti = parseInt(item.dataset.imgIdx);
      if (imgDragSrc===null||imgDragSrc===ti) return;
      const arr = getB();
      const imgs = arr[activeBoardIdx].images;
      const [moved] = imgs.splice(imgDragSrc,1);
      imgs.splice(ti,0,moved);
      setB(arr);
      renderLBImages(imgs);
      render();
    });
  });
}

function removeImg(i) {
  if (!confirm('Remove this image?')) return;
  const arr = getB();
  arr[activeBoardIdx].images.splice(i,1);
  setB(arr); renderLBImages(arr[activeBoardIdx].images); render();
}

function handleImgUpload(e) {
  if (activeBoardIdx < 0) return;
  const files = Array.from(e.target.files); let done = 0;
  const arr = getB();
  files.forEach(f => {
    const r = new FileReader();
    r.onload = ev => {
      cropToSquare(ev.target.result, sq => {
        arr[activeBoardIdx].images.push(sq);
        done++;
        if (done === files.length) { setB(arr); renderLBImages(arr[activeBoardIdx].images); render(); }
      });
    };
    r.readAsDataURL(f);
  });
  e.target.value = '';
}

/* ── MAIN RENDER ── */
function render() {
  const boards = getB();
  const cards = boards.map((b, i) => {
    const imgs = (b.images||[]).slice(0,4);
    const thumbs = Array(4).fill(null).map((_,j) =>
      imgs[j]
        ? `<div class="board-thumb"><img src="${imgs[j]}" alt=""></div>`
        : `<div class="board-thumb board-thumb-empty">◈</div>`
    ).join('');
    return `<div class="board-card reveal" onclick="openLB(${i})">
      <div class="board-mosaic">${thumbs}</div>
      <div class="board-hover"><span>Open Board →</span></div>
      <div class="board-info">
        <div class="board-name">${b.name}</div>
        ${b.desc ? `<div class="board-desc">${b.desc}</div>` : ''}
        <div class="board-count">${(b.images||[]).length} image${(b.images||[]).length!==1?'s':''}</div>
      </div>
    </div>`;
  }).join('');

  document.getElementById('boards-grid').innerHTML = cards +
    `<button class="add-board-btn" onclick="requireAuth(()=>openModal('board-modal'))">
      <span style="font-size:1.6rem;font-weight:100">+</span><span>New Moodboard</span>
    </button>`;

  setTimeout(()=>document.querySelectorAll('.reveal').forEach(el=>el.classList.add('visible')),50);
}

function openModal(id) { document.getElementById(id).classList.add('open'); document.body.style.overflow='hidden'; }
function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow=''; }
document.querySelectorAll('.modal-bg').forEach(bg=>bg.addEventListener('click',e=>{if(e.target===bg)closeModal(bg.id);}));
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){ document.querySelectorAll('.modal-bg.open').forEach(m=>closeModal(m.id)); closeLB(); }
});

render();
</script>
</body>
</html>
